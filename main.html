<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IIT JEE Study Tracker — Cloud Edition</title>
<style>
/* Theme & layout (dark bluish-purple gradient + glass cards) */
:root{
  --bg1:#071020; --bg2:#14143a; --card: rgba(255,255,255,0.04);
  --muted:#9fb0c6; --accent:#60a5fa;
  --math:#60a5fa; --phy:#34d399; --chem:#f472b6;
  --success:#16a34a; --warn:#f59e0b; --danger:#ef4444;
  --text:#e6eef6;
}
.light { --bg1:#f1f7fb; --bg2:#e6eef6; --card: rgba(2,6,23,0.04); --muted:#475569; --accent:#0ea5e9; --text:#07122a; }
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: linear-gradient(160deg,var(--bg1) 0%, #0f1b3b 45%, #22104a 100%);
  color:var(--text); min-height:100vh; padding:18px;
}
.container{max-width:1100px;margin:0 auto;}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;flex-wrap:wrap}
h1{margin:0;font-size:20px}
.small{font-size:13px;color:var(--muted)}
.card{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.06);backdrop-filter: blur(6px); border-radius:12px; padding:12px;}
.controls{display:flex;gap:8px;align-items:center}
button{cursor:pointer;border-radius:10px;padding:8px 10px;border:0;background:rgba(255,255,255,0.03);color:var(--text)}
button.primary{background:linear-gradient(90deg,var(--accent),#7dd3fc); color:#06202b}
button.warn{background:linear-gradient(90deg,var(--warn),#fbbf24); color:#111}
button.red{background:linear-gradient(90deg,var(--danger),#fb7185); color:#fff}
.pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
@media(max-width:980px){ .grid{grid-template-columns:1fr} .right-col{order:2} .left-col{order:1} }
.stats{display:flex;gap:12px}
.stat{flex:1;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
.cal-head{text-align:center;font-weight:600;color:var(--muted);font-size:13px}
.cal-cell{min-height:92px;border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;gap:6px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01))}
.cal-empty{background:transparent;border:0;min-height:32px}
.cal-green{background:linear-gradient(180deg, rgba(22,163,74,0.08), rgba(22,163,74,0.12))}
.cal-yellow{background:linear-gradient(180deg, rgba(245,158,11,0.06), rgba(245,158,11,0.12))}
.cal-red{background:linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.12))}
.task-overdue{outline:2px solid rgba(239,68,68,0.9);outline-offset:-3px}
.task-all-done{outline:2px solid rgba(16,185,129,0.85);outline-offset:-3px}
.subject-badge{display:inline-flex;align-items:center;gap:8px;padding:6px 8px;border-radius:10px;font-weight:600}
.badge-math{background:linear-gradient(90deg,var(--math),#93c5fd);color:#032b3a}
.badge-phy{background:linear-gradient(90deg,var(--phy),#86efac);color:#052412}
.badge-chem{background:linear-gradient(90deg,var(--chem),#f9a8d4);color:#2a0520}
.tasks-list{margin-top:10px;max-height:280px;overflow:auto;display:flex;flex-direction:column;gap:8px}
.task-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.progress-bar{height:10px;background:rgba(255,255,255,0.04);border-radius:999px;flex:1;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--math),var(--phy));width:0%}
.footer{margin-top:12px;color:var(--muted);font-size:13px}
.modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{width:460px;max-width:96%;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.06)}
@media(max-width:520px){ .cal-cell{min-height:74px} .card{padding:12px} }
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>IIT JEE Study Tracker</h1>
      <div class="small">Dark blue–purple theme • Calendar • Tasks • Timer • Cloud backup</div>
    </div>
    <div class="controls">
      <div id="userArea" style="display:flex;gap:8px;align-items:center">
        <span id="userEmail" class="small" style="display:none"></span>
        <button id="authBtn" class="pill">Login / Sign up</button>
        <button id="signOutBtn" style="display:none" class="pill">Sign out</button>
      </div>
      <select id="themeToggle" class="pill" title="Theme">
        <option value="dark">Dark</option><option value="light">Light</option>
      </select>
      <button id="clearToday" class="red">Clear Today</button>
      <button id="clearAll" class="red">Clear All</button>
    </div>
  </header>

  <!-- Analytics -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:0">
        <div class="stats">
          <div class="stat"><div class="small">Today</div><div id="statToday" style="font-weight:700">0h 0m</div><div class="small muted">Focus today</div></div>
          <div class="stat"><div class="small">This week</div><div id="statWeek" style="font-weight:700">0h 0m</div><div class="small muted">Last 7 days</div></div>
          <div class="stat"><div class="small">This month</div><div id="statMonth" style="font-weight:700">0h 0m</div><div class="small muted">Current month</div></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="pill small muted">Green ≥4h • Yellow 3–3.9h • Red &lt;3h</div>
        <button id="forceSync" class="pill">Sync Now</button>
      </div>
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid" style="margin-top:14px">
    <!-- left: calendar + tasks -->
    <div class="left-col">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevMonth">◀</button>
            <div id="monthLabel" style="min-width:200px;text-align:center;font-weight:700"></div>
            <button id="nextMonth">▶</button>
          </div>
          <div class="small muted">Click a day to view/add sessions or tasks</div>
        </div>
        <div class="cal-grid" id="calendarGrid">
          <div class="cal-head">Sun</div><div class="cal-head">Mon</div><div class="cal-head">Tue</div><div class="cal-head">Wed</div><div class="cal-head">Thu</div><div class="cal-head">Fri</div><div class="cal-head">Sat</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:700">Tasks</div><div class="small muted">Add tasks with subject and due date</div></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="taskTitle" type="text" placeholder="Task title" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
          <select id="taskSubject" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
            <option>Maths</option><option>Physics</option><option>Chemistry</option>
          </select>
          <input id="taskDue" type="date" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
          <button id="addTaskBtn" class="primary">Add</button>
        </div>

        <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
          <div class="small muted">Tasks progress</div>
          <div class="progress-bar" style="flex:1;margin-left:8px"><div id="taskProgressFill" class="progress-fill"></div></div>
          <div id="taskProgressText" class="small muted" style="min-width:70px;text-align:right">0 / 0</div>
        </div>

        <div class="tasks-list" id="tasksList"></div>
      </div>
    </div>

    <!-- right: study controls -->
    <div class="right-col">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div style="font-weight:700">Study Session</div><div class="small muted">Manual add or timer</div></div>
        </div>

        <!-- manual -->
        <div style="margin-top:10px">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select id="manualSubject" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
              <option>Maths</option><option>Physics</option><option>Chemistry</option>
            </select>
            <input id="manualMinutes" type="number" placeholder="minutes" min="1" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);width:110px">
            <input id="manualDate" type="date" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);width:160px">
            <button id="manualAddBtn" class="primary">Add</button>
          </div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">

        <!-- timer -->
        <div>
          <div class="small muted">Timer</div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <select id="timerSubject" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)"><option>Maths</option><option>Physics</option><option>Chemistry</option></select>
            <div id="timerDisplay" class="pill" style="min-width:120px;text-align:center;font-weight:700">00:00:00</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="timerStart" class="primary">Start</button><button id="timerPause">Pause</button><button id="timerSave" class="warn">Save Session</button>
          </div>
          <div class="small muted" style="margin-top:8px">Save session to a selected date in the modal (defaults to today).</div>
        </div>

        <div style="margin-top:12px">
          <div class="small muted">Totals — Maths: <span id="totalMaths">0h 0m</span> &nbsp; Physics: <span id="totalPhy">0h 0m</span> &nbsp; Chemistry: <span id="totalChem">0h 0m</span></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="add30Math" class="primary">+30m Maths</button>
          <button id="add30Phy" class="primary">+30m Physics</button>
          <button id="add30Chem" class="primary">+30m Chemistry</button>
        </div>
        <div class="footer">Saved locally and to your Firebase account when signed in.</div>
      </div>
    </div>
  </div>
</div>

<!-- modal root -->
<div id="modalRoot" style="display:none"></div>

<!-- Firebase SDK (modular) -->
<script type="module">
  // ---------- FIREBASE CONFIG ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // <-- REPLACED WITH YOUR CONFIG (you already provided) -->
  const firebaseConfig = {
    apiKey: "AIzaSyDlSi6BfY5E9PxAPiyIsrNCX5GknoFW3vQ",
    authDomain: "jeeprep-39f94.firebaseapp.com",
    projectId: "jeeprep-39f94",
    storageBucket: "jeeprep-39f94.firebasestorage.app",
    messagingSenderId: "82696955645",
    appId: "1:82696955645:web:b5854e950dec60590e4094"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- APP STATE ----------
  const STORAGE_KEY = 'JEE_TRACKER_V2';
  const THRESH_GREEN = 240;
  const THRESH_YELLOW = 180;
  const SUBJECTS = ['Maths','Physics','Chemistry'];

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function todayISO(d){ const D = d ? new Date(d) : new Date(); return D.toISOString().slice(0,10); }
  function loadLocal(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { sessions:[], tasks:[], settings:{theme:'dark'} } } catch(e){ return { sessions:[], tasks:[], settings:{theme:'dark'} } } }
  function saveLocal(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

  let state = loadLocal();
  // if no settings, ensure theme exists
  if(!state.settings) state.settings = { theme: 'dark' };

  // ---------- DOM refs ----------
  const authBtn = document.getElementById('authBtn');
  const signOutBtn = document.getElementById('signOutBtn');
  const userEmailSpan = document.getElementById('userEmail');
  const monthLabel = document.getElementById('monthLabel');
  const calendarGrid = document.getElementById('calendarGrid');
  const statToday = document.getElementById('statToday');
  const statWeek = document.getElementById('statWeek');
  const statMonth = document.getElementById('statMonth');
  const timerDisplay = document.getElementById('timerDisplay');
  const timerStart = document.getElementById('timerStart');
  const timerPause = document.getElementById('timerPause');
  const timerSave = document.getElementById('timerSave');
  const timerSubject = document.getElementById('timerSubject');
  const manualAddBtn = document.getElementById('manualAddBtn');
  const manualSubject = document.getElementById('manualSubject');
  const manualMinutes = document.getElementById('manualMinutes');
  const manualDate = document.getElementById('manualDate');
  const tasksList = document.getElementById('tasksList');
  const addTaskBtn = document.getElementById('addTaskBtn');
  const taskTitle = document.getElementById('taskTitle');
  const taskSubject = document.getElementById('taskSubject');
  const taskDue = document.getElementById('taskDue');
  const taskProgressFill = document.getElementById('taskProgressFill');
  const taskProgressText = document.getElementById('taskProgressText');
  const statMaths = document.getElementById('totalMaths');
  const statPhy = document.getElementById('totalPhy');
  const statChem = document.getElementById('totalChem');
  const clearTodayBtn = document.getElementById('clearToday');
  const clearAllBtn = document.getElementById('clearAll');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');
  const modalRoot = document.getElementById('modalRoot');
  const forceSyncBtn = document.getElementById('forceSync');

  // shortcuts
  document.getElementById('add30Math').addEventListener('click', ()=> quickAdd('Maths',30));
  document.getElementById('add30Phy').addEventListener('click', ()=> quickAdd('Physics',30));
  document.getElementById('add30Chem').addEventListener('click', ()=> quickAdd('Chemistry',30));

  function quickAdd(sub, minutes){ addSession({subject:sub, minutes, date: todayISO()}); renderAll(); autoSaveToFirestore(); }

  // ---------- calendar state ----------
  let viewDate = new Date();

  // ---------- timer ----------
  let timerRunning=false, timerStartedAt=null, timerElapsed = 0, timerInterval=null;
  function startTimer(){ if(timerRunning) return; timerRunning=true; timerStartedAt=Date.now(); timerInterval=setInterval(()=> {
      const now=Date.now();
      const delta = Math.floor((now - timerStartedAt)/1000) + timerElapsed;
      renderTimerDisplay(delta);
    }, 250);
  }
  function pauseTimer(){ if(!timerRunning) return; timerElapsed += Math.floor((Date.now()-timerStartedAt)/1000); timerRunning=false; timerStartedAt=null; clearInterval(timerInterval); renderTimerDisplay(timerElapsed); }
  function stopTimerReturnSecs(){ let total=0; if(timerRunning){ total = timerElapsed + Math.floor((Date.now()-timerStartedAt)/1000); timerElapsed=0; timerStartedAt=null; timerRunning=false; clearInterval(timerInterval); renderTimerDisplay(0); } else { total = timerElapsed; timerElapsed=0; renderTimerDisplay(0); } return total; }
  function renderTimerDisplay(sec){ const s=sec; const hh=String(Math.floor(s/3600)).padStart(2,'0'); const mm=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); timerDisplay.textContent=`${hh}:${mm}:${ss}`; }

  timerStart.addEventListener('click', ()=> startTimer());
  timerPause.addEventListener('click', ()=> pauseTimer());
  timerSave.addEventListener('click', ()=> {
    const seconds = stopTimerReturnSecs(); if(seconds <= 0){ alert('No time recorded. Start timer first.'); return; }
    const mins = Math.max(1, Math.round(seconds/60));
    openModal_SaveSession(mins, timerSubject.value);
  });

  // ---------- local data helpers ----------
  function addSession({subject, minutes, date}){ const d = date ? todayISO(date) : todayISO(); state.sessions.unshift({id:uid(), subject, minutes: Math.round(minutes), date:d}); saveLocal(state); renderAll(); }
  function sessionsOn(date){ return state.sessions.filter(s => s.date === date); }
  function minutesOn(date){ return state.sessions.filter(s => s.date === date).reduce((a,b)=> a + Number(b.minutes), 0); }
  function tasksOn(date){ return state.tasks.filter(t => t.due === date); }
  function overdueTasksOn(date){ const today = todayISO(); return state.tasks.filter(t => t.due === date && !t.done && (date < today)); }
  function allTasksDoneOn(date){ const tasks = tasksOn(date); return tasks.length>0 && tasks.every(t => t.done); }

  // ---------- analytics ----------
  function calcTotals(){
    const today = todayISO();
    const totalToday = minutesOn(today);
    // week:
    const now = new Date();
    let totalWeek = 0;
    for(let i=0;i<7;i++){ const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()-i); totalWeek += minutesOn(todayISO(d)); }
    // month (current month)
    const cur = new Date(); const curYear = cur.getFullYear(), curMonth = cur.getMonth();
    let totalMonth = 0;
    const daysInMonth = new Date(curYear, curMonth+1, 0).getDate();
    for(let d=1; d<=daysInMonth; d++){ totalMonth += minutesOn(`${curYear}-${String(curMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`); }
    return { today: totalToday, week: totalWeek, month: totalMonth };
  }

  function formatHM(mins){ const h = Math.floor(mins/60); const m = mins % 60; return `${h}h ${m}m`; }

  function renderAnalytics(){
    const t = calcTotals();
    statToday.textContent = formatHM(t.today); statWeek.textContent = formatHM(t.week); statMonth.textContent = formatHM(t.month);
    const today = todayISO();
    const tot = {Maths:0, Physics:0, Chemistry:0};
    sessionsOn(today).forEach(s => tot[s.subject] = (tot[s.subject]||0) + Number(s.minutes));
    statMaths.textContent = formatHM(tot.Maths); statPhy.textContent = formatHM(tot.Physics); statChem.textContent = formatHM(tot.Chemistry);
  }

  // ---------- render calendar ----------
  function renderCalendar(){
    // clear old date cells (keep headers)
    const existing = calendarGrid.querySelectorAll('.cal-cell, .cal-empty'); existing.forEach(n => n.remove());
    const year = viewDate.getFullYear(), month = viewDate.getMonth();
    monthLabel.textContent = viewDate.toLocaleString(undefined, {month: 'long', year: 'numeric'});
    const firstDayIndex = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    for(let i=0;i<firstDayIndex;i++){ const e = document.createElement('div'); e.className='cal-empty'; calendarGrid.appendChild(e); }
    for(let d=1; d<=daysInMonth; d++){
      const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const mins = minutesOn(dateKey);
      const cell = document.createElement('div'); cell.className='cal-cell card';
      if(mins >= THRESH_GREEN) cell.classList.add('cal-green'); else if(mins >= THRESH_YELLOW) cell.classList.add('cal-yellow'); else if(mins > 0) cell.classList.add('cal-red');
      if(overdueTasksOn(dateKey).length > 0) cell.classList.add('task-overdue'); else if(allTasksDoneOn(dateKey)) cell.classList.add('task-all-done');
      const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between';
      const left = document.createElement('div'); left.textContent = d; left.style.fontWeight='700';
      const right = document.createElement('div'); right.className='small muted'; right.textContent = formatHM(mins);
      top.appendChild(left); top.appendChild(right); cell.appendChild(top);
      // subject badges
      const subjTotals = {Maths:0, Physics:0, Chemistry:0}; sessionsOn(dateKey).forEach(s=> subjTotals[s.subject]+=Number(s.minutes));
      const badgesRow = document.createElement('div'); badgesRow.style.display='flex'; badgesRow.style.gap='6px'; badgesRow.style.marginTop='6px';
      SUBJECTS.forEach(s => { if(subjTotals[s]){ const b = document.createElement('div'); b.className='subject-badge small'; if(s==='Maths') b.classList.add('badge-math'); if(s==='Physics') b.classList.add('badge-phy'); if(s==='Chemistry') b.classList.add('badge-chem'); b.textContent = `${s} • ${Math.round(subjTotals[s]/60*10)/10}h`; badgesRow.appendChild(b); }});
      cell.appendChild(badgesRow);
      cell.addEventListener('click', ()=> openModal_DateDetail(dateKey));
      calendarGrid.appendChild(cell);
    }
    renderAnalytics();
  }

  // ---------- tasks render ----------
  function renderTasks(){
    tasksList.innerHTML = '';
    if(!state.tasks || state.tasks.length === 0){ tasksList.innerHTML = '<div class="small muted">No tasks yet</div>'; renderTaskProgress(); return; }
    state.tasks.forEach(task => {
      const row = document.createElement('div'); row.className='task-row';
      const left = document.createElement('div'); left.style.display='flex'; left.style.gap='10px'; left.style.alignItems='center';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!task.done; cb.addEventListener('change', ()=> { task.done = cb.checked; saveLocal(state); autoSaveToFirestore(); renderTasks(); renderCalendar(); renderTaskProgress(); });
      const meta = document.createElement('div'); const title = document.createElement('div'); title.textContent = task.title; title.style.fontWeight='700'; const subt = document.createElement('div'); subt.className='small muted'; subt.innerHTML = `<span class="${task.subject==='Maths'?'badge-math':task.subject==='Physics'?'badge-phy':'badge-chem'}" style="padding:3px 6px;border-radius:999px;margin-right:8px">${task.subject}</span>Due: ${task.due}`;
      meta.appendChild(title); meta.appendChild(subt);
      left.appendChild(cb); left.appendChild(meta);
      const right = document.createElement('div'); const del = document.createElement('button'); del.textContent='Delete'; del.className='red'; del.addEventListener('click', ()=> { if(!confirm('Delete task?')) return; state.tasks = state.tasks.filter(t=>t.id!==task.id); saveLocal(state); autoSaveToFirestore(); renderTasks(); renderCalendar(); renderTaskProgress(); });
      right.appendChild(del);
      if(task.done) title.style.textDecoration='line-through', title.style.opacity='0.6';
      row.appendChild(left); row.appendChild(right);
      tasksList.appendChild(row);
    });
    renderTaskProgress();
  }

  function renderTaskProgress(){ const total = state.tasks.length || 0; const done = state.tasks.filter(t=>t.done).length || 0; const pct = total === 0 ? 0 : Math.round(done/total*100); taskProgressFill.style.width = pct + '%'; taskProgressText.textContent = `${done} / ${total}`; }

  // ---------- modal: date details ----------
  function openModal_DateDetail(dateKey){
    const existingSessions = sessionsOn(dateKey);
    const existingTasks = tasksOn(dateKey);
    const modal = document.createElement('div'); modal.className='modal-bg';
    const inner = document.createElement('div'); inner.className='modal card';
    const h = document.createElement('div'); h.style.display='flex'; h.style.justifyContent='space-between'; h.style.alignItems='center';
    h.innerHTML = `<div><strong>Details — ${dateKey}</strong><div class="small muted">${existingSessions.length} sessions • ${existingTasks.length} tasks</div></div><div><button id="closeModal">Close</button></div>`;
    inner.appendChild(h);
    const sessWrap = document.createElement('div'); sessWrap.style.marginTop='10px'; sessWrap.innerHTML = `<div style="font-weight:700">Sessions</div>`;
    if(existingSessions.length === 0) sessWrap.innerHTML += `<div class="small muted">No sessions</div>`;
    existingSessions.forEach(s => {
      const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.style.alignItems='center'; r.style.padding='6px 0';
      r.innerHTML = `<div><strong>${s.subject}</strong> • ${s.minutes} min</div><div><button class="red small">Delete</button></div>`;
      r.querySelector('button').addEventListener('click', ()=> { if(!confirm('Delete this session?')) return; state.sessions = state.sessions.filter(x=>x.id !== s.id); saveLocal(state); autoSaveToFirestore(); modal.remove(); renderAll(); });
      sessWrap.appendChild(r);
    });
    const quick = document.createElement('div'); quick.style.marginTop='8px';
    quick.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><select id="modalSubject" style="padding:6px;border-radius:8px"><option>Maths</option><option>Physics</option><option>Chemistry</option></select><input id="modalMins" type="number" placeholder="minutes" style="padding:6px;border-radius:8px;width:100px" /><button id="modalAddBtn" class="primary">Add</button></div>`;
    sessWrap.appendChild(quick); inner.appendChild(sessWrap);

    const tasksWrap = document.createElement('div'); tasksWrap.style.marginTop='12px'; tasksWrap.innerHTML = `<div style="font-weight:700">Tasks for ${dateKey}</div>`;
    if(existingTasks.length === 0) tasksWrap.innerHTML += `<div class="small muted">No tasks due</div>`;
    existingTasks.forEach(t => {
      const tr = document.createElement('div'); tr.style.display='flex'; tr.style.justifyContent='space-between'; tr.style.alignItems='center'; tr.style.padding='6px 0';
      tr.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><input type="checkbox" ${t.done? 'checked':''} /> <div><strong style="${t.done? 'text-decoration:line-through;opacity:.6':''}">${t.title}</strong><div class="small muted">${t.subject}</div></div></div><div><button class="red small">Delete</button></div>`;
      tr.querySelector('input').addEventListener('change', (e)=> { const item = state.tasks.find(x=>x.id===t.id); if(item){ item.done = e.target.checked; saveLocal(state); autoSaveToFirestore(); renderTasks(); renderCalendar(); renderTaskProgress(); }});
      tr.querySelector('button').addEventListener('click', ()=> { if(!confirm('Delete task?')) return; state.tasks = state.tasks.filter(x=>x.id !== t.id); saveLocal(state); autoSaveToFirestore(); modal.remove(); renderAll(); });
      tasksWrap.appendChild(tr);
    });
    inner.appendChild(tasksWrap);

    modal.appendChild(inner); modalRoot.innerHTML=''; modalRoot.appendChild(modal); modalRoot.style.display='block';
    document.getElementById('closeModal').addEventListener('click', ()=> { modal.remove(); modalRoot.style.display='none'; });

    document.getElementById('modalAddBtn').addEventListener('click', ()=> {
      const subj = document.getElementById('modalSubject').value;
      const mins = Math.round(Number(document.getElementById('modalMins').value) || 0);
      if(mins <= 0) return alert('Enter minutes');
      addSession({subject:subj, minutes:mins, date: dateKey}); modal.remove(); modalRoot.style.display='none'; renderAll(); autoSaveToFirestore();
    });
  }

  // ---------- save session modal ----------
  function openModal_SaveSession(mins, subj){
    const modal = document.createElement('div'); modal.className='modal-bg';
    const inner = document.createElement('div'); inner.className='modal card';
    inner.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Save session</strong><div class="small muted">${mins} minute(s) ready to save</div></div><div><button id="msClose">Close</button></div></div>
      <div style="margin-top:10px"><div style="display:flex;gap:8px;align-items:center"><label class="small muted">Subject</label><select id="msSubject" style="padding:6px;border-radius:8px"><option ${subj==='Maths'?'selected':''}>Maths</option><option ${subj==='Physics'?'selected':''}>Physics</option><option ${subj==='Chemistry'?'selected':''}>Chemistry</option></select><label class="small muted">Date</label><input id="msDate" type="date" style="padding:6px;border-radius:8px" value="${todayISO()}" /></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="msCancel">Cancel</button><button id="msSave" class="primary">Save</button></div></div>`;
    modal.appendChild(inner); modalRoot.innerHTML=''; modalRoot.appendChild(modal); modalRoot.style.display='block';
    document.getElementById('msClose').addEventListener('click', ()=> { modal.remove(); modalRoot.style.display='none'; });
    document.getElementById('msCancel').addEventListener('click', ()=> { modal.remove(); modalRoot.style.display='none'; });
    document.getElementById('msSave').addEventListener('click', ()=> {
      const s = document.getElementById('msSubject').value; const d = document.getElementById('msDate').value || todayISO();
      addSession({subject:s, minutes:mins, date: d}); modal.remove(); modalRoot.style.display='none'; renderAll(); autoSaveToFirestore();
    });
  }

  // ---------- saving/loading to Firestore ----------
  // We'll store whole state in /users/{uid}/tracker as a single document
  async function autoSaveToFirestore(){
    const user = auth.currentUser;
    if(!user) return; // only when signed in
    try{
      const ref = doc(db, 'users', user.uid, 'meta', 'tracker');
      await setDoc(ref, state);
      console.log('Synced to Firestore');
    }catch(e){ console.warn('Firestore save failed', e); }
  }
  async function loadFromFirestoreForUser(user){
    try{
      const ref = doc(db, 'users', user.uid, 'meta', 'tracker');
      const snap = await getDoc(ref);
      if(snap.exists()){
        const serverState = snap.data();
        // Merge strategy: prefer server state if exists; but keep local sessions not in server (optional)
        // For simplicity, we'll replace local with server
        state = serverState;
        if(!state.settings) state.settings = { theme:'dark' };
        saveLocal(state);
        renderAll();
      } else {
        // no server data: push local to server
        await setDoc(ref, state);
      }
    }catch(e){ console.warn('Failed to load from Firestore', e); }
  }

  // ---------- auth UI (popup modal for login/signup) ----------
  authBtn.addEventListener('click', ()=> openAuthModal());

  async function openAuthModal(){
    const modal = document.createElement('div'); modal.className='modal-bg';
    const inner = document.createElement('div'); inner.className='modal card';
    inner.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Login / Sign up</strong><div class="small muted">Use email & password</div></div><div><button id="closeAuth">Close</button></div></div>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <input id="authEmail" type="email" placeholder="Email" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
        <input id="authPass" type="password" placeholder="Password (min 6 chars)" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="authSignup" class="primary">Create account</button>
          <button id="authLogin">Login</button>
        </div>
      </div>`;
    modal.appendChild(inner); modalRoot.innerHTML=''; modalRoot.appendChild(modal); modalRoot.style.display='block';
    document.getElementById('closeAuth').addEventListener('click', ()=> { modal.remove(); modalRoot.style.display='none'; });

    document.getElementById('authSignup').addEventListener('click', async ()=>{
      const mail = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if(!mail || !pass) return alert('Enter email & password');
      try{
        const userCred = await createUserWithEmailAndPassword(auth, mail, pass);
        alert('Account created — you are now signed in.');
        modal.remove(); modalRoot.style.display='none';
      }catch(e){ alert('Signup error: ' + e.message); }
    });

    document.getElementById('authLogin').addEventListener('click', async ()=>{
      const mail = document.getElementById('authEmail').value.trim();
      const pass = document.getElementById('authPass').value;
      if(!mail || !pass) return alert('Enter email & password');
      try{
        await signInWithEmailAndPassword(auth, mail, pass);
        modal.remove(); modalRoot.style.display='none';
      }catch(e){ alert('Login error: ' + e.message); }
    });
  }

  // sign out
  signOutBtn.addEventListener('click', async ()=> {
    await signOut(auth);
  });

  // auth state listener
  onAuthStateChanged(auth, async (user) => {
    if(user){
      console.log('Signed in', user.email);
      userEmailSpan.style.display='inline-block'; userEmailSpan.textContent = user.email; authBtn.style.display='none'; signOutBtn.style.display='inline-block';
      // load user data from Firestore and override local
      await loadFromFirestoreForUser(user);
    } else {
      console.log('Signed out'); userEmailSpan.style.display='none'; authBtn.style.display='inline-block'; signOutBtn.style.display='none';
      // no user: keep local state only
    }
  });

  // manual add handler
  manualAddBtn.addEventListener('click', ()=> {
    const mins = Math.round(Number(manualMinutes.value) || 0); if(mins <= 0) return alert('Enter minutes > 0');
    const subj = manualSubject.value; const date = manualDate.value ? manualDate.value : todayISO();
    addSession({subject:subj, minutes:mins, date}); manualMinutes.value=''; manualDate.value = '';
    saveLocal(state); renderAll(); autoSaveToFirestore();
  });

  // add task
  addTaskBtn.addEventListener('click', ()=>{
    const title = taskTitle.value.trim(); const subj = taskSubject.value; const due = taskDue.value;
    if(!title) return alert('Enter task title'); if(!due) return alert('Choose due date');
    state.tasks.unshift({ id: uid(), title, subject:subj, due, done:false });
    saveLocal(state); taskTitle.value=''; taskDue.value=''; renderTasks(); renderCalendar(); autoSaveToFirestore();
  });

  // clear actions
  clearAllBtn.addEventListener('click', ()=> {
    if(!confirm('Clear all sessions and tasks? This cannot be undone.')) return;
    state = { sessions:[], tasks:[], settings: state.settings || {theme:'dark'} };
    saveLocal(state); renderAll(); autoSaveToFirestore();
  });
  clearTodayBtn.addEventListener('click', ()=> {
    if(!confirm('Clear today\'s sessions? Tasks will not be removed.')) return;
    const t = todayISO(); state.sessions = state.sessions.filter(s => s.date !== t); saveLocal(state); renderAll(); autoSaveToFirestore();
  });

  // month nav
  prevMonthBtn.addEventListener('click', ()=> { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1); renderCalendar(); });
  nextMonthBtn.addEventListener('click', ()=> { viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1); renderCalendar(); });

  // timer save modal open handled earlier
  // shortcuts
  document.getElementById('add30Math').addEventListener('click', ()=> { addSession({subject:'Maths', minutes:30, date: todayISO()}); saveLocal(state); renderAll(); autoSaveToFirestore(); });
  document.getElementById('add30Phy').addEventListener('click', ()=> { addSession({subject:'Physics', minutes:30, date: todayISO()}); saveLocal(state); renderAll(); autoSaveToFirestore(); });
  document.getElementById('add30Chem').addEventListener('click', ()=> { addSession({subject:'Chemistry', minutes:30, date: todayISO()}); saveLocal(state); renderAll(); autoSaveToFirestore(); });

  // force sync button
  forceSyncBtn.addEventListener('click', ()=> { autoSaveToFirestore(); alert('Sync attempted'); });

  // ---------- render / init ----------
  function renderAll(){ renderCalendar(); renderTasks(); renderTaskProgress(); renderAnalytics(); renderTimerDisplay(0); }
  function init(){ document.getElementById('manualDate').value = todayISO(); if(!state.tasks) state.tasks = []; if(!state.sessions) state.sessions = []; applyTheme(state.settings.theme || 'dark'); renderAll(); }
  init();

  // theme toggle
  const themeToggle = document.getElementById('themeToggle');
  function applyTheme(t){ if(t==='light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light'); state.settings = state.settings || {}; state.settings.theme = t; saveLocal(state); }
  themeToggle.value = state.settings.theme || 'dark'; themeToggle.addEventListener('change', (e)=> { applyTheme(e.target.value); autoSaveToFirestore(); });

  // helper: auto-save local state on unload
  window.addEventListener('beforeunload', ()=> saveLocal(state));

  // auto save periodically (just in case)
  setInterval(()=> saveLocal(state), 5000);

  // Expose openModal_SaveSession and other helpers to window for use in UI
  window.openModal_SaveSession = (mins, subj) => openModal_SaveSession(mins, subj);
  window.openModal_DateDetail = (d) => openModal_DateDetail(d);

  // expose basic functions for developer console if needed
  window.__jee_state = state;
  window.syncNow = autoSaveToFirestore;

</script>
</body>
</html>
